ICMP checksum をいじるツール

はじめに

  私は、NTT 西日本のフレッツ光プレミアムを使っていて、少なくとも私のと
  ころでは、traceroute がうまく動作しない。調査したところ、CTU を越えて
  返ってきた ICMP の checksum が狂っていることが判った。

  ECHO REQUEST や ECHO REPLY は問題ないが、TIME EXCEEDED や DEST
  UNREACHABLE は狂うようである。

  さらなる調査の結果、本来の checksum を計算する方法が判ったので、ここ
  に実装してみた。


注意

  このプログラムはネットワークを流れるパケットを書き換える。私のところ
  では問題なく動作しているように見えるが、正しく書き換えているという保
  証はないし、ICMP 以外も含めて正常なパケットに影響を及ぼすかもしれない。

  このプログラムを使用した結果、何が起きても、私は責任を負わない。

  このプログラムを使用するには、いろいろな知識を必要とする。Linux 管理,
  TCP/IP protocol stack, iptables, netfilter, C言語, bash shell script
  など。このプログラムは、これらの知識を十分に持っている人を対象として
  いる。


ネットワーク構成

  以下のようなネットワーク構成を前提としている。

    [PC] --- [CTU] ---- フレッツ光プレミアム

    [PC] --- [PC] --- [CTU] ---- フレッツ光プレミアム
          (firewall)

  このプログラムは、CTU のすぐ内側にある PC で使用する。


必要なもの

  - Linux
  - iptables
  - libnetfilter_queue-0.0.15
  - libnfnetlink-0.0.30

  libnfnetlink や libnetfilter_queue は、今後、仕様が変更になるような気
  がするので、できるだけこのバージョンを推奨。


インストール

  make を実行すると icmpcsum ができるので、これを cp で /usr/sbin/ 辺り
  にコピーする。


使い方

  firewall で使う場合、このプログラムより先にも checksum のチェックが行
  われるので、以下のコマンドで無効にする。

    echo 0 > /proc/sys/net/netfilter/nf_conntrack_checksum

  代わりに sysctl でやっても良い。

  以下のコマンドを実行する。

    iptables -t mangle -A PREROUTING -i eth1 --source \! 192.168.0.0/16 -p icmp -j NFQUEUE --queue-num=100

  mangle テーブルの PREROUTING に rule を追加している。

  -i と --source で、CTU を越えてきたパケットのみに限定している。CTU を
  越えていないパケットについては、checksum は狂っていないので、
  checksum 書き換え対象にしない。

  -p icmp で ICMP だけに制限している。icmpcsum の方でもチェックしている
  が、設定ミスやプログラムのバグなどで TCP パケットをいじってしまわない
  よう、重複してチェックする方が良い。また、ここでチェックしておけば
  TCP パケットをユーザ空間に転送する必要がなく、負荷的な影響を最小限に
  抑えることができる。

  これでマッチしたパケットは NFQUEUE でユーザ空間に転送する。NFQUEUE は
  パケットのキューを 65536 本持っており、0〜65535 の中から自由に選択し
  て良い。上の例では 100 を指定している。

  以下のコマンドを実行する。

    icmpcsum -i <何かコマンド> -o <何かコマンド> -q 100

  -q は iptables の実行の時に指定したキューの番号と同じものを指定する。

  本来の checksum を計算するのは、CTU の外側の IP アドレスと、PC の外側
  の IP アドレスが必要である。これらのアドレスは変化する可能性があるの
  で、定期的に確認する必要がある。アドレスを取得する方法は OS やユーザ
  各自の環境に依存するだろうから、icmpcsum としては、取得方法を指定して
  もらうことにした。

  -i に指定したコマンドは、PC の外側の IP アドレスを出力しなければなら
  ない。また、-o に指定したコマンドは、CTU の外側の IP アドレスを出力し
  なければならない。

  これらは、icmpcsum 実行時と、その後は1時間おきに実行される。例えば
  CTU を再起動してグローバルアドレスが変わっても、最大1時間経てば新しい
  IP アドレスを認識する、ということである。

  icmpcsum 実行時にアドレスを出力しなかった場合、icmpcsum はすぐに終了
  する。1時間おきの実行でアドレスを出力しなかった場合、それまで知ってい
  たアドレスをそのまま使う。

  OS 起動時など、まだ外側のインタフェースを UP してなくて、CTU のアドレ
  スが判らないかもしれない。そういう状態で icmpcsum を起動し、コマンド
  がエラーを返すと、icmpcsum も終了してしまう。実行順序をよく検討するか、
  OS を落とす前のアドレスをどこかに記録しておくか、何らかの対策が必要だ
  ろう。

  さて、icmpcsum を実行すると、以下の出力がある場合がある。

    NFNETLINK answers: File exists

  これは気にしなくて良い。

  最後に動作を確認する。どこかに traceroute して試してみると良い。問題
  なく動作するはずである。


また注意

  iptables に rule を追加しておいて icmpcsum を起動していない状態では、
  その rule にマッチしたパケットは全て捨てられてしまう。


ライセンス

  GPL2 とする。COPYING を参照のこと。


作者

  Yuuki Harano <masm@flowernet.gr.jp>
